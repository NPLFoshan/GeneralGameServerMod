<template>
    <div style="display: inline;">
        <editbox ref="input" v-bind:value="value" style="display:inline-block; width: 180px; background: url(Texture/Aries/Creator/keepwork/ggs/user/shuruzhuangdi_16X16_32bits.png#0 0 16 16: 5 5 5 5);"></editbox>
        <button v-on:click="confirm" style="display:inline-block; height: 28px; width: 55px; text-align: center; background: url(Texture/Aries/Creator/keepwork/ggs/user/btn_confirm_16X16_32bits.png#0 0 16 16: 5 5 5 5);">确认</button>
        <button v-on:click="cancel" style="display:inline-block; height: 28px; width: 55px; text-align: center; background: url(Texture/Aries/Creator/keepwork/ggs/user/btn_cancel_16X16_32bits.png#0 0 16 16: 5 5 5 5);">取消</button>
    </div>
</template>

<script type="text/lua">
function OnRefresh()
    self.value = self.nickname;
    
    GetRef("input"):GetControl():setFocus("click");
end

local function FinishCallback(value, notify)
    if (type(finish) == "function") then
        finish(value);
    end

    if (notify) then
        GameLogic.GetFilters():apply_filters("ggs", {action = "UpdateNickName", nickname = value});
        GameLogic.GetFilters():apply_filters("ggs", {action = "UpdateUserInfo", userinfo = {nickname = value}});
    end
end

function cancel()
    FinishCallback(self.nickname, false);
end

function confirm()
    local inputEl = GetRef("input");
    local value = inputEl:GetUIValue();

    -- 客户端处理铭感词
    value = MyCompany.Aries.Chat.BadWordFilter.FilterString(value);
    
    _guihelper.MessageBox("修改昵称将消耗 10 个知识豆, 请确认是否修改", function(res)
        if( res ~= _guihelper.DialogResult.OK) then return cancel() end
        keepwork.user.setinfo({
            router_params = {id = userId},
            nickname = value,
        }, function(status, msg, data) 
            if (status < 200 or status >= 300) then 
                _guihelper.MessageBox(data and data.message or "修改昵称失败", nil, _guihelper.MessageBoxButtons.Nothing);
                return cancel() 
            end
            _guihelper.MessageBox("修改昵称成功, 知识豆-10", nil, _guihelper.MessageBoxButtons.Nothing);
            UserDetail.bean = UserDetail.bean - 10;
            FinishCallback(value, true);
        end);
    end, _guihelper.MessageBoxButtons.OKCancel_CustomLabel,nil,nil,nil,nil, {ok = "修改", cancel = "取消"});
end 

</script>

<!-- MyCompany.Aries.Chat.BadWordFilter.FilterString -->