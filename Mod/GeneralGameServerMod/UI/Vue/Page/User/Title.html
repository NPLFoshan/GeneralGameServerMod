<template>
    <div style="padding-left:10px; padding-right:20px; height:39px; padding-top: 10px;">
        <div style="float: left; width:128px; height:64px; margin-top:-28px; background: url(Texture/Aries/Creator/keepwork/ggs/user/biaoti_128X64_32bits.png);"></div>
        <div onclick=ClickHelp style="float: left; width:32px; height: 32px; margin-top: -6px; margin-left: -16px; background: url(Texture/Aries/Creator/keepwork/Help/btn_32X32_32bits.png;0 0 32 32);"></div>
        <div onclick=close class="btn" style="float: right; background:url(Texture/Aries/Creator/keepwork/ggs/dialog/guanbi_22X22_32bits.png#0 0 22 22); width:20px; height:20px;"></div>
    </div>
</template>

<script type="text/lua">
    local KeepWorkItemManager = NPL.load("(gl)script/apps/Aries/Creator/HttpAPI/KeepWorkItemManager.lua");
    NPL.load("(gl)script/apps/Aries/Creator/Game/Entity/CustomCharItems.lua");
    local CustomCharItems = commonlib.gettable("MyCompany.Aries.Game.EntityManager.CustomCharItems");

    function ClickHelp()
        NPL.load("(gl)script/apps/Aries/Creator/Game/Tasks/Help/HelpPage.lua").Show("role");
    end 

    function removeAllUnvalidItems(skin)
        local currentSkin = skin;
        local isVip = KeepWorkItemManager.IsVip();
        local itemIds = commonlib.split(skin, ";");
        if (itemIds and #itemIds > 0) then
            for _, id in ipairs(itemIds) do
                local data = CustomCharItems:GetItemById(id);
                if (data) then
                    if ((not data.gsid and not isVip) or (data.gsid and not KeepWorkItemManager.HasGSItem(data.gsid))) then
                        currentSkin = CustomCharItems:RemoveItemInSkin(currentSkin, id);
                    end
                end
            end
        end
        return currentSkin;
    end

    function removeActivityItems(skin)
        local currentSkin = skin;
        local isVip = KeepWorkItemManager.IsVip();
        local itemIds = commonlib.split(skin, ";");
        if (itemIds and #itemIds > 0) then
            for _, id in ipairs(itemIds) do
                local data = CustomCharItems:GetItemById(id);
                if (data) then
                    if (data.gsid and not KeepWorkItemManager.HasGSItem(data.gsid)) then
                        currentSkin = CustomCharItems:RemoveItemInSkin(currentSkin, id);
                    end
                end
            end
        end
        return currentSkin;
    end

    function close()
        if (isAuthUser) then
            local assetfile = GetGlobalScope():Get("MainAsset");
            local skin = GetGlobalScope():Get("MainSkin");
            if (assetfile and skin and skin ~= "" and type(skin) == "string") then
             if (assetfile == CustomCharItems.defaultModelFile and not CustomCharItems:CheckAvatarExist(skin)) then
                 skin = CustomCharItems:ChangeSkinStringToItems(skin);
                 local GameLogic = commonlib.gettable("MyCompany.Aries.Game.GameLogic")
                 GameLogic.IsVip("ChangeAvatarSkin", true, function(isVip)
                     if(isVip) then
                         skin = removeActivityItems(skin);
                         local playerEntity = GameLogic.GetPlayerController():GetPlayer();
                         playerEntity:SetMainAssetPath(assetfile);
                         GameLogic.options:SetMainPlayerAssetName(assetfile);
                         GameLogic.options:SetMainPlayerSkins(skin);
                         playerEntity:SetSkin(skin);
                         GlobalScope:Set("AssetSkinGoodsItemId", 0);
                         UpdatePlayerEntityInfo();
                     else
                         skin = removeAllUnvalidItems(skin);
                         if (skin ~= nil and skin ~= "") then
                             local playerEntity = GameLogic.GetPlayerController():GetPlayer();
                             playerEntity:SetMainAssetPath(assetfile);
                             GameLogic.options:SetMainPlayerAssetName(assetfile);
                             GameLogic.options:SetMainPlayerSkins(skin);
                             playerEntity:SetSkin(skin);
                             GlobalScope:Set("AssetSkinGoodsItemId", 0);
                             UpdatePlayerEntityInfo();
                         end
                     end
                     CloseWindow();
                 end)
             else
                 CloseWindow();
             end
            else
             CloseWindow();
            end
        else
            CloseWindow();
        end
    end
</script>

<style>
    .btn {
        background-color: #e6e6e6;
    }

    .btn:hover {
        background-color: #ffffff;
    }
</style>
