<template class="container">
    <WindowTitleBar title="自定义图块" v-bind:close="Close"></WindowTitleBar>
    <div style="position: absolute; left: 2px; top: 39px; right: 0px; bottom: 2px;">
        <Blockly ref="BlocklyEditor" class="blockly-editor" type="block" onchange=OnBlocklyChange></Blockly>
        <Blockly readonly=true ref="BlocklyPreview" class="blockly-preview" onchange=OnBlocklyChange isHideToolBox=true isHideIcons="true"></Blockly>
        <div class="textarea-container"><textarea v-model="BlockDefineCode" style="width: 100%; height: 100%;"></textarea></div>
    </div>
</template>

<script type="text/lua">
RegisterComponent("WindowTitleBar", "%vue%/Components/WindowTitleBar.html");
local Page = NPL.load("Mod/GeneralGameServerMod/UI/Page.lua");

local BlocklyEditor = nil;
local BlocklyPreview = nil;
local BlockOption = {};
BlockDefineCode = "";
function OnReady()
    BlocklyEditor = GetRef("BlocklyEditor");
    BlocklyPreview = GetRef("BlocklyPreview");
    OnBlocklyChange();
end

function Close()
    Page.ShowMessageBoxPage({
        text = "是否保存修改?",
        confirm = function()
            BlockOption.xml_text = BlocklyEditor:SaveToXmlNodeText();
            CloseWindow();
        end,
        cancel = CloseWindow,
    });
end

function GenerateBlockOption()
    local rawcode, prettycode = BlocklyEditor:GetCode();
    local prettycode = string.gsub(prettycode, "\t", "    ");
    local G = {message = "", arg = {}, field_count = 0, type="block", category = "category", color = "#2E9BEF", output = false, previousStatement = true, nextStatement = true};
    <!-- print(prettycode) -->
    local func, errmsg = loadstring(prettycode);
    setfenv(func, G);
    func();
    G.message = string.gsub(G.message, "^ ", "");
    return G;
end

function PreviewBlockOption(blockOption)
    BlocklyPreview:DefineBlock(blockOption);
    local block = BlocklyPreview:GetBlockInstanceByType(blockOption.type);
    BlocklyPreview:ClearBlocks();
    block:SetLeftTopUnitCount(10, 10);
    block:UpdateLayout();
    BlocklyPreview:AddBlock(block);
end

function GenerateBlockDefineCode(option)
    local indent = "        ";
    local arg_var_define = indent .. "local args = {};\n";

    for i, arg in ipairs(option.arg) do
        if (arg.type == "input_value" or arg.type == "input_statement") then
            arg_var_define = arg_var_define .. string.format('%sargs["%s"] = block:GetValueAsString("%s");\n', indent, arg.name, arg.name);
        else
            arg_var_define = arg_var_define .. string.format('%sargs["%s"] = block:GetFieldValue("%s");\n', indent, arg.name, arg.name);
        end
    end 

    local code_description = option.code_description or "";
    code_description = string.gsub(code_description, "\n+$", "");
    code_description = string.gsub(code_description, "^\n+", "");
    if (option.output) then
        code_description = "[[" .. code_description .. "]]";
    else
        code_description = "[[\n" .. code_description .. "\n]]";
    end
    local func_description = string.gsub(code_description, "%$(%w+)", "%%s");
    local block_define_code = string.format([[
{
    type = "%s",
    category = "%s",
    output = "%s",
    previousStatement = "%s", 
    nextStatement = "%s",
    message = "%s",
    %s,
    func_description = %s,
    ToNPL = function(block)
%s
        -- 更改下行为图块实际生成代码
        return string.gsub(%s, "%%$(%%w+)", args); 
    end
}]], option.type, option.category, option.output, option.previousStatement, option.nextStatement, option.message, 
    commonlib.dump(option.arg, "arg", false, 2), func_description,
    arg_var_define, code_description);

    return block_define_code;
end

function OnBlocklyChange()
    BlockOption = GenerateBlockOption();
    BlockDefineCode = GenerateBlockDefineCode(BlockOption);
    PreviewBlockOption(BlockOption);
end

</script>

<style scoped=true>
.container {
    width: 100%;
    height: 100%;
    background: url(Texture/Aries/Creator/keepwork/Window/dakuang2_32bits.png#0 0 64 69:26 44 24 22);
}

.blockly-editor {
    position: absolute;
    left: 0px;
    top: 0px;
    width: 800;
    bottom: 0px;
}

.blockly-preview {
    position: absolute;
    left: 802px;
    top: 0px;
    right: 2px;
    height: 300px;
}

.textarea-container {
    position: absolute;
    left: 802px;
    top: 302px;
    right: 2px;
    bottom: 0px;
}
</style>