<template class="container">
    <WindowTitleBar title="自定义图块"></WindowTitleBar>
    <div style="position: absolute; left: 2px; top: 39px; right: 0px; bottom: 2px;">
        <Blockly ref="BlocklyEditor" class="blockly-editor" type="block" onchange=OnBlocklyChange></Blockly>
        <Blockly readonly=true ref="BlocklyPreview" class="blockly-preview" onchange=OnBlocklyChange isHideToolBox=true isHideIcons="true"></Blockly>
        <div class="textarea-container"><textarea v-model="BlockDefineCode" style="width: 100%; height: 100%;"></textarea></div>
    </div>
</template>

<script type="text/lua">
RegisterComponent("WindowTitleBar", "%vue%/Components/WindowTitleBar.html");

local BlocklyEditor = nil;
local BlocklyPreview = nil;
BlockDefineCode = "";
function OnReady()
    BlocklyEditor = GetRef("BlocklyEditor");
    BlocklyPreview = GetRef("BlocklyPreview");
    OnBlocklyChange();
end

function GenerateBlockOption()
    local rawcode, prettycode = BlocklyEditor:GetCode();
    local prettycode = string.gsub(prettycode, "\t", "    ");
    local G = {message = "", arg = {}, field_count = 0, type="block", category = "category", color = "#2E9BEF", output = false, previousStatement = true, nextStatement = true,};
    local func, errmsg = loadstring(prettycode);
    setfenv(func, G);
    func();
    G.message =string.gsub(G.message, "^ ", "");
    return G;
end

function PreviewBlockOption(blockOption)
    BlocklyPreview:DefineBlock(blockOption);
    local block = BlocklyPreview:GetBlockInstanceByType(blockOption.type);
    BlocklyPreview:ClearBlocks();
    block:SetLeftTopUnitCount(10, 10);
    block:UpdateLayout();
    BlocklyPreview:AddBlock(block);
end

function GenerateBlockDefineCode(option)
    local field_values = {};
    local fields = {};
    for i, arg in ipairs(option.arg) do
        fields[i] = "%s";
        if (arg.type == "input_value" or arg.type == "input_statement") then
            field_values[i] = string.format('block:GetValueAsString("%s")', arg.name);   
        else
            field_values[i] = string.format('block:GetFieldValue("%s")', arg.name);   
        end
    end 

    local block_define_code = string.format([[
{
    type = "%s",
    category = "%s",
    output = "%s",
    previousStatement = "%s", 
    nextStatement = "%s",
    message = "%s",
    %s,
    ToNPL = function(block)
        local values = {%s};
        -- 更改下行为图块实际生成代码
        return string.format('%s\n', table.unpack(values)); 
    end
}]], option.type, option.category, option.output, option.previousStatement, option.nextStatement, option.message, 
    commonlib.dump(option.arg, "arg", false, 2), 
    table.concat(field_values, ","), table.concat(fields, " "));
    return block_define_code;
end

function OnBlocklyChange()
    local blockOption = GenerateBlockOption();
    BlockDefineCode = GenerateBlockDefineCode(blockOption);
    PreviewBlockOption(blockOption);
end

</script>

<style scoped=true>
.container {
    width: 100%;
    height: 100%;
    background: url(Texture/Aries/Creator/keepwork/Window/dakuang2_32bits.png#0 0 64 69:26 44 24 22);
}

.blockly-editor {
    position: absolute;
    left: 0px;
    top: 0px;
    width: 800;
    bottom: 0px;
}

.blockly-preview {
    position: absolute;
    left: 802px;
    top: 0px;
    right: 2px;
    height: 300px;
}

.textarea-container {
    position: absolute;
    left: 802px;
    top: 302px;
    right: 2px;
    bottom: 2px;
}
</style>